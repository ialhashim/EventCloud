<!DOCTYPE html>
<html>
<head>
<title>EventCloud : Event view</title>

<link rel="stylesheet" href="css/reset-min.css">
<link rel="stylesheet" href="css/buttons.css">
<link rel="stylesheet" href="css/custom.css">
<link rel="stylesheet" href="css/font-awesome.css">

<script type="text/javascript" charset="utf-8" src="js/jquery-1.10.1.min.js"></script>
<script type="text/javascript" charset="utf-8" src="cordova-2.7.0.js"></script>
<script type="text/javascript" charset="utf-8" src="js/global.js"></script>


<script type="text/javascript" charset="utf-8">
	var username;
	var eid;
	var eventname = '';
	
	$(document).ready(function() { 
		username = $.getUrlVar('username');
		EID = $.getUrlVar('eid');
		
		// Get event name
		$.get(eventsManager, { request: "name", eid: EID }, function(data){ 
			eventname = data.name; 
			$("h2#greeting").replaceWith( "<h2 id='greeting'> " + toTitleCase(username) + " @ " + eventname + " </h2>" );
		});
		
		postUpload();
		
		// Disable scrolling
		$(document.body).on('touchmove',function(e){
		    if(!$('.scroll-pane').has($(e.target)).length)
		        e.preventDefault();
		});
	});
	
	
	// Video
	//
	function captureVideo() {
		// Launch device video recording application, 
		// allowing user to capture up to 2 video clips
		navigator.device.capture.captureVideo(captureSuccess, captureError);
	}

	function captureSuccess(mediaFiles) {
		var i, len;
		for (i = 0, len = mediaFiles.length; i < len; i += 1) {
			uploadVideoFile(mediaFiles[i]);
		}
	}

	function captureError(error) {
		if (error != CAPTURE_NO_MEDIA_FILES) {
			var msg = 'An error occurred during capture: ' + error.code;
			navigator.notification.alert(msg, null, 'Uh oh!');
		}
	}

	// Photo
	//
	function capturePhoto() {
		navigator.camera.getPicture(uploadPhotoFile, photoError, {
			quality : 50,
			destinationType : navigator.camera.DestinationType.FILE_URI
		});
	}

	function photoError(message) {
		var msg = 'An error occurred during capture: ' + error.code;
		navigator.notification.alert(msg, null, 'Uh oh!');
	}

	// Upload files to server
	function uploadVideoFile(mediaFile) {
		var ft = new FileTransfer(),
        	path = mediaFile.fullPath,
        	name = mediaFile.name;
            
		//var options = new FileUploadOptions();
		//options.fileName = name;
		
	    ft.upload(path, uploadURL, up_win, up_fail, { fileName: name }, true);
	}
	
	function uploadPhotoFile(imageURI) {
	    var options = new FileUploadOptions();
	    options.fileKey="file";
	    options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);
	    options.mimeType="image/jpeg";
	
	    var ft = new FileTransfer();
	    ft.upload(imageURI, uploadURL, up_win, up_fail, options, true);
	}
	
	function up_win(r) {
        console.log("Upload OK, Code = " + r.responseCode);
        console.log("Response = " + r.response);
        console.log("Sent = " + r.bytesSent);
        postUpload();
    }

    function up_fail(error) {
        alert("An error has occurred: Code = " + error.code);
        console.log("upload error source " + error.source);
        console.log("upload error target " + error.target);
    }
    
    function postUpload() {
   	   var request = $.ajax({
   	        url: galleryURL,
   	        type: "post"
   	    });

   	    // callback handler that will be called on success
   	    request.done(function (response, textStatus, jqXHR){
   	        console.log("Hooray, ajax worked!");
   	        
   	        // Refresh gallery
   	        $("#gallery").replaceWith(response);
   	        

   			$("#gallery").wrapInner("<table cellspacing='30'><tr>");
   			$(".thumbnail").wrap("<td></td>");
   			
   	    });
    }
    
</script>
</head>

<body onload="onBodyLoad()">
	<div id="mainScreen">
		<div id="wrapper">
			<div style="text-align:center"> <h2 id="greeting">Signing in..</h2> </div>
			<div class="scroll-pane">
				<div id="gallery" style="margin:auto; width: 300px; color:white"> </div>
			</div>
			
						
			<a id="camera" class="special-button button back" onclick="capturePhoto();"> <i class="icon-camera"> </i></a> 
			<a id="video" class="special-button button back" onclick="captureVideo();"> <i class="icon-facetime-video"> </i></a> 
			<a id="upload" class="special-button button back" href=""> <i class="icon-upload"> </i></a> 
			<a id="history" class="special-button button back" onclick="postUpload();"> <i	class="icon-backward"> </i></a> 
			<a id="volume" class="special-button button back" style="height:1em" href=""> 
				<span class="icon-stack" style="display:block;font-size: 0.9em; margin-top: -0.5em;" > 
					<i class="icon-volume-up icon-stack"> </i>
					<i class="icon-ban-circle text-error" style="color: #9d261d;font-size:200%"> </i>
				</span>
			</a> 
			
		</div>
	</div>
</body>
</html>